<!doctype html>
<html lang="de" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Destiny 2 ‚Äì Raid Clears | Hambi rocks</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2216%22>üõ°Ô∏è</text></svg>">
  <style>
    /* Smooth table overflow on mobile */
    .table-wrapper { overflow-x: auto; }
  </style>
</head>
<body class="h-full bg-white text-slate-800 dark:bg-slate-900 dark:text-slate-100">
  <header class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold tracking-tight">Destiny 2 ‚Äì Vault of Glass Clears</h1>
    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
      Live aus <code>results.json</code> geladen ‚Ä¢ <span id="updated"></span>
    </p>

    <div class="mt-6 flex flex-col sm:flex-row gap-3 sm:items-center">
      <input id="search" type="text"
             class="w-full sm:w-72 rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 text-sm"
             placeholder="Spieler suchen‚Ä¶" />
      <button id="sort-btn"
              class="rounded-md border border-slate-300 dark:border-slate-700 px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800">
        Nach Clears sortieren (‚ñº)
      </button>
      <button id="download-csv"
              class="rounded-md border border-emerald-400 text-emerald-600 dark:text-emerald-300 dark:border-emerald-900 px-3 py-2 text-sm hover:bg-emerald-50 dark:hover:bg-emerald-900/20">
        CSV herunterladen
      </button>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 pb-24">
    <div class="table-wrapper rounded-lg border border-slate-200 dark:border-slate-800 shadow-sm">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 dark:bg-slate-800/50">
          <tr>
            <th class="text-left px-4 py-2 font-semibold">Name</th>
            <th class="text-right px-4 py-2 font-semibold">VoG Clears</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <p id="count" class="text-xs text-slate-500 dark:text-slate-400 mt-2"></p>
  </main>

  <footer class="border-t border-slate-200 dark:border-slate-800 py-6 text-center text-xs text-slate-500 dark:text-slate-400">
    ¬© <span id="year"></span> Hambi rocks
  </footer>

  <script>
    const DATA_URL = 'results.json'; // ggf. anpassen
    let data = [];
    let sortDesc = true;

    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    function render(list) {
      const tbody = $('#tbody');
      tbody.innerHTML = '';
      for (const row of list) {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-100 dark:border-slate-800';
        tr.innerHTML = `
          <td class="px-4 py-2 whitespace-nowrap">${escapeHtml(row.name)}</td>
          <td class="px-4 py-2 text-right font-mono">${row.vog_completions}</td>
        `;
        tbody.appendChild(tr);
      }
      $('#count').textContent = `${list.length} Spieler angezeigt`;
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    function toCSV(list) {
      const header = 'name,vog_completions';
      const lines = list.map(r =>
        `"${String(r.name).replace(/"/g, '""')}",${r.vog_completions}`
      );
      return [header, ...lines].join('\n');
    }

    async function init() {
      const res = await fetch(DATA_URL, { cache: 'no-store' });
      data = await res.json();
      sortData();
      render(data);

      $('#sort-btn').addEventListener('click', () => {
        sortDesc = !sortDesc;
        $('#sort-btn').textContent = `Nach Clears sortieren (${sortDesc ? '‚ñº' : '‚ñ≤'})`;
        sortData();
        render(filtered($('#search').value));
      });

      $('#search').addEventListener('input', (e) => {
        render(filtered(e.target.value));
      });

      $('#download-csv').addEventListener('click', () => {
        const csv = toCSV(filtered($('#search').value));
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'vog_clears.csv';
        a.click();
        URL.revokeObjectURL(url);
      });

      $('#year').textContent = new Date().getFullYear();
      $('#updated').textContent = `Stand: ${new Date().toLocaleString()}`;
    }

    function sortData() {
      data.sort((a, b) => sortDesc
        ? b.vog_completions - a.vog_completions
        : a.vog_completions - b.vog_completions
      );
    }

    function filtered(query) {
      query = query.trim().toLowerCase();
      if (!query) return data;
      return data.filter(r => r.name.toLowerCase().includes(query));
    }

    init();
  </script>
</body>
</html>
